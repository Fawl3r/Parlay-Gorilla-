databases:
  # Primary application database (Render PostgreSQL)
  - name: parlay-gorilla-postgres
    region: oregon
    # Paid plan recommended for production (free DBs expire).
    plan: basic-256mb

services:
  # Redis-compatible store used for:
  # - Distributed Odds API cache (credits protection across instances)
  # - Scheduler leader election (prevents duplicate scheduled jobs)
  - type: keyvalue
    name: parlay-gorilla-redis
    region: oregon
    plan: free
    # Restrict access to Render private network only
    ipAllowList: []

  # Frontend moved to Cloudflare (Workers/Pages). See docs/deploy/CLOUDFLARE_FRONTEND_MIGRATION.md.
  # - type: web
  #   name: parlay-gorilla-frontend
  #   env: node
  #   region: oregon
  #   plan: free
  #   domains:
  #     - www.parlaygorilla.com
  #   rootDir: frontend
  #   buildCommand: npm install --no-audit --no-fund && npm run build
  #   startCommand: npm run start -- -p $PORT -H 0.0.0.0
  #   envVars:
  #     - key: PG_BACKEND_URL
  #       fromService: { name: parlay-gorilla-backend, type: web, property: hostport }
  #     - key: NEXT_PUBLIC_SITE_URL
  #       value: https://www.parlaygorilla.com
  #     - key: NEXT_PUBLIC_API_URL
  #       value: https://api.parlaygorilla.com

  - type: web
    name: parlay-gorilla-backend
    env: python
    region: oregon
    plan: starter
    domains:
      - api.parlaygorilla.com
    # Monorepo: backend lives in ./backend
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: bash start.sh
    envVars:
      # Redis URL is automatically wired from the Key Value service
      - key: REDIS_URL
        fromService:
          name: parlay-gorilla-redis
          type: keyvalue
          property: connectionString

      # Non-secret config
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: "false"
      - key: USE_SQLITE
        value: "false"
      - key: OPENAI_ENABLED
        value: "true"

      # Required secrets / URLs (prompted during Blueprint creation)
      - key: DATABASE_URL
        fromDatabase:
          name: parlay-gorilla-postgres
          property: connectionString
      - key: THE_ODDS_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: GORILLA_BOT_ENABLED
        value: "true"
      - key: GORILLA_BOT_MODEL
        value: "gpt-4o-mini"
      - key: GORILLA_BOT_EMBEDDING_MODEL
        value: "text-embedding-3-small"
      - key: GORILLA_BOT_KB_PATH
        value: "docs/gorilla-bot/kb"
      # API-Sports (optional - for enhanced features, 100 req/day free tier)
      - key: API_SPORTS_API_KEY
        sync: false
      - key: APISPORTS_BASE_URL
        value: "https://v3.football.api-sports.io"
      - key: APISPORTS_DAILY_QUOTA
        value: "100"
      - key: JWT_SECRET
        generateValue: true
      - key: FRONTEND_URL
        value: https://www.parlaygorilla.com
      - key: BACKEND_URL
        value: https://api.parlaygorilla.com
      - key: APP_URL
        value: https://www.parlaygorilla.com
      
      # Payment Providers (set if you want to accept payments)
      - key: LEMONSQUEEZY_API_KEY
        sync: false
      - key: LEMONSQUEEZY_STORE_ID
        sync: false
      - key: LEMONSQUEEZY_WEBHOOK_SECRET
        sync: false
      - key: LEMONSQUEEZY_PREMIUM_MONTHLY_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_PREMIUM_ANNUAL_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_LIFETIME_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_CREDITS_10_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_CREDITS_25_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_CREDITS_50_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_CREDITS_100_VARIANT_ID
        sync: false
      - key: COINBASE_COMMERCE_API_KEY
        sync: false
      - key: COINBASE_COMMERCE_WEBHOOK_SECRET
        sync: false
      
      # Web Push Notifications (optional - set if you want push notifications)
      - key: WEB_PUSH_ENABLED
        value: "false"
      - key: WEB_PUSH_VAPID_PUBLIC_KEY
        sync: false
      - key: WEB_PUSH_VAPID_PRIVATE_KEY
        sync: false
      - key: WEB_PUSH_SUBJECT
        value: mailto:support@parlaygorilla.com

      # Telegram alerts (optional - parlay/odds/repair failures + unhandled exceptions)
      - key: TELEGRAM_ALERTS_ENABLED
        value: "false"
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false

  # Node worker: consumes Redis queue and creates immutable verification records (server-signed).
  # NOTE: Worker services require a paid Render plan (Starter or higher).
  - type: worker
    name: parlay-gorilla-verification-worker
    env: node
    region: oregon
    plan: starter  # Worker services require paid plan
    rootDir: backend/verification-worker
    buildCommand: npm install --no-audit --no-fund && npm run build
    startCommand: npm run start
    envVars:
      - key: REDIS_URL
        fromService:
          name: parlay-gorilla-redis
          type: keyvalue
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: parlay-gorilla-postgres
          property: connectionString
      - key: VERIFICATION_QUEUE_KEY
        value: parlay_gorilla:queue:verify_saved_parlay
      - key: VERIFICATION_MAX_ATTEMPTS
        value: "5"
      - key: SUI_RPC_URL
        sync: false
      - key: SUI_PRIVATE_KEY
        sync: false
      - key: SUI_PACKAGE_ID
        sync: false
      - key: SUI_MODULE
        value: parlay_proof
      - key: SUI_FUNCTION
        value: create_proof

